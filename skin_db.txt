-- Xóa DB cũ đi để làm lại cho sạch
DROP DATABASE IF EXISTS skin_db;

-- Tạo một database mới
CREATE DATABASE IF NOT EXISTS skin_db
CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Sử dụng database
USE skin_db;

-- Tạo bảng người dùng (users)
CREATE TABLE IF NOT EXISTS users (
    user_id INT AUTO_INCREMENT PRIMARY KEY,
    
    -- ĐÃ SỬA: Giảm từ 255 xuống 191
    email VARCHAR(191) NOT NULL UNIQUE, 
    
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    `role` ENUM('user', 'admin') NOT NULL DEFAULT 'user',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tạo bảng lịch sử chẩn đoán
CREATE TABLE IF NOT EXISTS diagnosis_history (
    history_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    image_url VARCHAR(512) NOT NULL,
    disease_name VARCHAR(255),
    confidence_score DECIMAL(5, 4),
    result_json TEXT,
    diagnosed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);

-- Thêm các cột cho Open ID
ALTER TABLE users
    ADD COLUMN provider VARCHAR(50) NOT NULL DEFAULT 'local' AFTER full_name;

ALTER TABLE users
    -- ĐÃ SỬA: Giảm từ 255 xuống 191
    ADD COLUMN provider_id VARCHAR(191) NULL UNIQUE AFTER provider;

-- Sửa cột password cho phép NULL
ALTER TABLE users
    MODIFY COLUMN password_hash VARCHAR(255) NULL;

-- Thêm cột cho Mã Reset Mật khẩu
ALTER TABLE users
    ADD COLUMN reset_token VARCHAR(255) NULL AFTER provider_id;
    
ALTER TABLE users
    ADD COLUMN reset_token_expires TIMESTAMP NULL AFTER reset_token;
    
-- Thêm cột trạng thái
ALTER TABLE users
    ADD COLUMN account_status ENUM('active', 'suspended') NOT NULL DEFAULT 'active'
    AFTER `role`;

-- XÓA KHÓA NGOẠI CŨ
-- (Lưu ý: Tên khóa ngoại 'diagnosis_history_ibfk_1' là tên mặc định, 
-- nếu bạn đặt tên khác hoặc nó báo lỗi, hãy kiểm tra lại tên trong tab 'Structure' của phpMyAdmin)
ALTER TABLE diagnosis_history
    DROP FOREIGN KEY diagnosis_history_ibfk_1;

-- THÊM LẠI KHÓA NGOẠI, BẬT "ON DELETE CASCADE"
ALTER TABLE diagnosis_history
    ADD CONSTRAINT fk_user_history
    FOREIGN KEY (user_id) REFERENCES users(user_id)
    ON DELETE CASCADE;

-- Tạo bảng để lưu trữ phản hồi
CREATE TABLE IF NOT EXISTS feedback (
    feedback_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NULL, 
    feedback_type VARCHAR(50) NOT NULL DEFAULT 'other',
    content TEXT NOT NULL,
    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE SET NULL
);

-- Tạo bảng để lưu trữ các nguồn tin
CREATE TABLE IF NOT EXISTS news_sources (
    source_id INT AUTO_INCREMENT PRIMARY KEY,
    url VARCHAR(191) NOT NULL UNIQUE,
    label VARCHAR(191),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

ALTER TABLE users
ADD COLUMN avatar_url VARCHAR(512) NULL DEFAULT NULL
AFTER full_name;

CREATE TABLE IF NOT EXISTS feedback (
    feedback_id INT AUTO_INCREMENT PRIMARY KEY,
    -- Khóa ngoại liên kết tới người dùng đã gửi
    user_id INT NULL, -- Cho phép NULL
    -- Loại phản hồi (ví dụ: 'bug', 'suggestion', 'other')
    feedback_type VARCHAR(50) NOT NULL DEFAULT 'other',
    -- Nội dung phản hồi
    content TEXT NOT NULL,
    -- Ngày giờ gửi
    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    -- Liên kết với bảng users
    -- ON DELETE SET NULL: Nếu user bị xóa (bởi Admin),
    -- chúng ta vẫn giữ feedback (dưới dạng vô danh)
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE SET NULL
);

-- Các lệnh bạn dùng để kiểm tra
select * from users;
select * from diagnosis_history;

-- (Ví dụ) Gán quyền admin cho email của bạn
UPDATE users SET `role` = 'admin' WHERE email = 'duytruongton@gmail.com';